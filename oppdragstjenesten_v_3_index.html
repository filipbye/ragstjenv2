<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Oppdragstjenesten ‚Äî Mobil</title>
  <meta name="description" content="Koselig norsk tjeneste for sm√• oppdrag. Laget for mobil." />
  <!-- Netlify Identity widget (works n√•r du hoster p√• Netlify og aktiverer Identity) -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <!-- Leaflet for kart (OpenStreetMap) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#f6fbf9; --card:#ffffff; --accent:#63b3a2; --muted:#6b7280; --accent-2:#8bd3c4;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; background:var(--bg); color:#0f172a}
    /* Topbar */
    header{display:flex;align-items:center;gap:12px;padding:12px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white}
    .menu-btn{background:transparent;border:none;color:white;font-size:22px}
    .brand{font-weight:700;font-size:18px}

    /* Layout */
    .wrap{display:grid;grid-template-columns:1fr;gap:10px;padding:14px}
    /* sidebar overlay */
    .sidebar{position:fixed;left:0;top:0;bottom:0;width:260px;background:var(--card);box-shadow:2px 0 10px rgba(15,23,42,0.08);transform:translateX(-110%);transition:transform .22s ease;padding:18px}
    .sidebar.open{transform:translateX(0)}
    .sidebar h3{margin:0 0 12px}
    .nav a{display:flex;gap:10px;align-items:center;padding:10px;border-radius:8px;color:#0f172a;text-decoration:none}
    .nav a:hover{background:#f0fff8}

    /* cards */
    .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(3,7,18,0.04);}

    /* forms */
    input,textarea,select,button{font-family:inherit}
    input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef0;background:transparent}
    textarea{min-height:100px}
    .btn{background:var(--accent);color:white;padding:10px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn.secondary{background:#eef8f6;color:var(--accent)}

    /* tasks list */
    .task{padding:10px;border-radius:10px;margin-bottom:10px;border:1px solid #eef4f2;background:#fff}
    .task h4{margin:0 0 6px}
    .meta{font-size:13px;color:var(--muted)}
    .flex{display:flex;gap:8px}

    /* profile */
    .avatar{width:72px;height:72px;border-radius:12px;object-fit:cover}

    /* chat */
    .chat{display:flex;flex-direction:column;height:60vh}
    .messages{flex:1;overflow:auto;padding:8px}
    .message{margin:6px 0;max-width:80%}
    .me{align-self:flex-end;background:#dcfce7;padding:8px;border-radius:10px}
    .them{align-self:flex-start;background:#fff;padding:8px;border-radius:10px}

    /* responsive */
    @media(min-width:760px){.wrap{max-width:900px;margin:14px auto}}
  </style>
</head>
<body>
  <header>
    <button class="menu-btn" id="menuBtn">‚ò∞</button>
    <div class="brand">Oppdragstjenesten</div>
  </header>

  <nav class="sidebar" id="sidebar">
    <h3>Oppdragstjenesten</h3>
    <div class="nav">
      <a href="#home" data-route="home">üè† Hjem</a>
      <a href="#profile" data-route="profile">üë§ Profil</a>
      <a href="#search" data-route="search">üîé S√∏k oppdrag</a>
      <a href="#create" data-route="create">‚ûï Legg ut oppdrag</a>
      <a href="#chat" data-route="chat">üí¨ Meldinger</a>
      <a href="#about" data-route="about">‚ÑπÔ∏è Om oss</a>
      <hr>
      <div id="authArea"></div>
    </div>
  </nav>

  <main class="wrap" id="app">
    <!-- HOME -->
    <section id="home" class="card page">
      <h2>Velkommen!</h2>
      <p>Oppdragstjenesten er laget for √• hjelpe mennesker som trenger hjelp med ting hjemme. Eks rydde, klippe plenen, handle i butikken. Dette er for deg som har lyst til √• hjelpe andre.</p>
      <div style="margin-top:12px" class="flex">
        <button class="btn" id="toSearch">S√∏k oppdrag</button>
        <button class="btn secondary" id="toCreate">Legg ut oppdrag</button>
      </div>
      <h3 style="margin-top:14px">Nye oppdrag n√¶r deg</h3>
      <div id="feed"></div>
    </section>

    <!-- PROFILE -->
    <section id="profile" class="card page" style="display:none">
      <h2>Min profil</h2>
      <div style="display:flex;gap:12px;align-items:center">
        <img id="avatarPreview" class="avatar" src="" alt="avatar" />
        <div style="flex:1">
          <input id="displayName" placeholder="Ditt navn" />
          <div class="meta">E-post: <span id="profileEmail"></span></div>
          <div style="margin-top:8px"><button class="btn" id="saveProfile">Lagre profil</button></div>
        </div>
      </div>
      <div style="margin-top:12px">
        <label>Last opp profilbilde (valgfritt)</label>
        <input type="file" id="avatarInput" accept="image/*" />
      </div>
      <h3 style="margin-top:12px">Din rating</h3>
      <div id="ratingArea">Ingen vurderinger enda</div>
    </section>

    <!-- SEARCH -->
    <section id="search" class="card page" style="display:none">
      <h2>S√∏k oppdrag</h2>
      <input id="searchInput" placeholder="S√∏k etter tittel eller sted" />
      <div style="margin-top:10px" id="searchResults"></div>
      <h4 style="margin-top:12px">Kart</h4>
      <div id="map" style="height:240px;border-radius:8px;overflow:hidden"></div>
    </section>

    <!-- CREATE -->
    <section id="create" class="card page" style="display:none">
      <h2>Legg ut oppdrag</h2>
      <input id="taskTitle" placeholder="Tittel (f.eks. Handle)" />
      <input id="taskPrice" placeholder="Pris (kr)" type="number" />
      <textarea id="taskDesc" placeholder="Beskrivelse"></textarea>
      <input id="taskLocation" placeholder="Stedsnavn eller adresse (valgfritt)" />
      <div style="margin-top:8px"><button class="btn" id="publishTask">Publiser oppdrag</button></div>
    </section>

    <!-- CHAT -->
    <section id="chat" class="card page" style="display:none">
      <h2>Meldinger</h2>
      <div class="chat">
        <div class="messages" id="messages"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="msgInput" placeholder="Skriv melding..." />
          <button class="btn" id="sendMsg">Send</button>
        </div>
      </div>
    </section>

    <!-- ABOUT -->
    <section id="about" class="card page" style="display:none">
      <h2>Om Oppdragstjenesten</h2>
      <p>Oppdragstjenesten er laget for √• hjelpe mennesker som trenger hjelp med ting hjemme. Eks rydde, klippe plenen, handle i butikken. Dette er for deg som har lyst til √• hjelpe andre.</p>
    </section>
  </main>

  <script>
    // ========= App data storage (localStorage-based prototype) =========
    // This version uses localStorage to keep tasks, profiles and messages.
    // When deploying to Netlify you can later swap storage calls to serverless functions or Supabase.

    const SIDEBAR = document.getElementById('sidebar');
    const menuBtn = document.getElementById('menuBtn');
    const pages = document.querySelectorAll('.page');
    const navLinks = document.querySelectorAll('.nav a');

    // simple router
    function show(route){
      pages.forEach(p=>p.style.display='none');
      const el = document.getElementById(route);
      if(el) el.style.display='block';
      // close sidebar on navigation (mobile)
      SIDEBAR.classList.remove('open');
    }

    menuBtn.addEventListener('click', ()=>{SIDEBAR.classList.toggle('open')});
    navLinks.forEach(a=>a.addEventListener('click',(e)=>{e.preventDefault();show(a.dataset.route)}));

    document.getElementById('toSearch').addEventListener('click',()=>show('search'));
    document.getElementById('toCreate').addEventListener('click',()=>show('create'));

    // storage helpers
    function loadTasks(){
      return JSON.parse(localStorage.getItem('tasks_v3')||'[]');
    }
    function saveTasks(tasks){
      localStorage.setItem('tasks_v3',JSON.stringify(tasks));
    }
    function loadProfiles(){
      return JSON.parse(localStorage.getItem('profiles_v3')||'{}');
    }
    function saveProfiles(p){
      localStorage.setItem('profiles_v3',JSON.stringify(p));
    }
    function loadMessages(){
      return JSON.parse(localStorage.getItem('messages_v3')||'{}');
    }
    function saveMessages(m){
      localStorage.setItem('messages_v3',JSON.stringify(m));
    }

    // ========== Netlify Identity integration (login) ==========
    // Requires you to deploy on Netlify and enable Identity (email/password + registration)

    if(window.netlifyIdentity){
      window.netlifyIdentity.on('init', user => { renderAuth(user); });
      window.netlifyIdentity.on('login', user => { renderAuth(user); window.netlifyIdentity.close(); loadAppFor(user); });
      window.netlifyIdentity.on('logout', ()=>{ renderAuth(null); loadAppFor(null); });
      window.netlifyIdentity.init();
    }

    function renderAuth(user){
      const area = document.getElementById('authArea');
      area.innerHTML = '';
      if(user){
        area.innerHTML = `<div style="margin-top:10px">Innlogget som <strong>${user.email}</strong><br><button id='btnLogout' class='btn secondary'>Logg ut</button></div>`;
        document.getElementById('btnLogout').onclick = ()=>window.netlifyIdentity.logout();
        // show profile email
        document.getElementById('profileEmail').textContent = user.email;
        loadAppFor(user);
      } else {
        area.innerHTML = `<button id='btnLogin' class='btn'>Logg inn / Registrer</button>`;
        document.getElementById('btnLogin').onclick = ()=>window.netlifyIdentity.open();
      }
    }

    // ========== App logic linked to identity (or local fallback) ==========
    let currentUser = null; // {email, id}

    function loadAppFor(user){
      if(user){ currentUser = { email:user.email, id:user.id || user.email } }
      else currentUser = null;
      renderFeed();
      renderProfile();
    }

    // Local fallback: if Netlify Identity not available, create a simple local "session" via prompt (DEV only)
    if(!window.netlifyIdentity){
      // create demo login button
      const area = document.getElementById('authArea');
      area.innerHTML = `<button id='demoLogin' class='btn'>Demo-Login</button>`;
      document.getElementById('demoLogin').onclick = ()=>{
        const em = prompt('Skriv e-post for demo eller la st√• tom for anonym');
        currentUser = { email: em || ('anon'+Date.now()), id: em || ('anon'+Date.now()) };
        renderFeed(); renderProfile();
      }
    }

    // ========== Tasks UI ==========
    function renderFeed(){
      const feed = document.getElementById('feed'); feed.innerHTML='';
      const tasks = loadTasks();
      tasks.slice().reverse().forEach(t=>{
        const div = document.createElement('div'); div.className='task';
        div.innerHTML = `<h4>${t.title} ${t.price?(' - '+t.price+' kr'):''}</h4><div class='meta'>${t.description}</div><div class='meta'>${t.location?('Sted: '+t.location):''} ‚Ä¢ <small>Publisert av: ${t.user}</small></div>`;
        // actions
        const actions = document.createElement('div'); actions.className='flex';
        const takeBtn = document.createElement('button'); takeBtn.className='btn secondary'; takeBtn.textContent='Ta oppdrag';
        takeBtn.onclick = ()=>takeTask(t.id);
        actions.appendChild(takeBtn);
        if(currentUser && currentUser.email === t.user){
          const del = document.createElement('button'); del.className='btn'; del.textContent='Slett'; del.onclick = ()=>{ if(confirm('Slette oppdrag?')) deleteTask(t.id); };
          actions.appendChild(del);
        }
        div.appendChild(actions);
        feed.appendChild(div);
      });
    }

    function publishTask(){
      if(!currentUser){ alert('Du m√• v√¶re logget inn for √• publisere oppdrag'); return }
      const t = { id: 't'+Date.now(), title: document.getElementById('taskTitle').value || 'Uten tittel', description: document.getElementById('taskDesc').value||'', price: document.getElementById('taskPrice').value||'', location: document.getElementById('taskLocation').value||'', user: currentUser.email, created: Date.now(), takenBy: null };
      const tasks = loadTasks(); tasks.push(t); saveTasks(tasks); renderFeed(); alert('Oppdrag publisert')
      show('home');
    }

    function deleteTask(id){ const tasks = loadTasks().filter(t=>t.id!==id); saveTasks(tasks); renderFeed(); }

    function takeTask(id){
      if(!currentUser){ alert('Logg inn for √• ta oppdrag'); return }
      const tasks = loadTasks();
      const t = tasks.find(x=>x.id===id);
      if(!t) return alert('Oppdrag ikke funnet');
      if(t.takenBy) return alert('Oppdraget er allerede tatt av '+t.takenBy);
      // Choice model: first-come gets it
      t.takenBy = currentUser.email; t.status='in-progress'; saveTasks(tasks); renderFeed(); alert('Du har tatt oppdraget. Avtal tid via meldinger.');
    }

    function completeTask(id){ const tasks=loadTasks(); const t=tasks.find(x=>x.id===id); if(t){ t.status='done'; saveTasks(tasks); alert('Oppdrag markert som fullf√∏rt. Gi feedback p√• profilen.'); renderFeed(); }}

    // ========== Profile ==========
    function renderProfile(){
      const pEmail = document.getElementById('profileEmail');
      const avatar = document.getElementById('avatarPreview');
      const nameInput = document.getElementById('displayName');
      const profiles = loadProfiles();
      if(!currentUser){ pEmail.textContent='(ikke innlogget)'; avatar.src=''; nameInput.value=''; document.getElementById('ratingArea').innerText='Ingen vurderinger enda'; return }
      const key = currentUser.email;
      const profile = profiles[key] || {name:'', avatar:'', ratings:[]};
      pEmail.textContent = currentUser.email; avatar.src = profile.avatar || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="72" height="72"><rect width="100%" height="100%" fill="%23e6f6ef"/><text x="50%" y="50%" font-size="10" dominant-baseline="middle" text-anchor="middle" fill="%2363b3a2">Profil</text></svg>';
      nameInput.value = profile.name || '';
      // ratings
      if(profile.ratings && profile.ratings.length){ document.getElementById('ratingArea').innerText = profile.ratings.map(r=>r.score+': '+r.comment).join('\n'); } else { document.getElementById('ratingArea').innerText = 'Ingen vurderinger enda' }
    }

    document.getElementById('saveProfile').onclick = ()=>{
      if(!currentUser){ alert('Logg inn f√∏rst'); return }
      const profiles = loadProfiles(); const key = currentUser.email; profiles[key] = profiles[key] || {ratings:[]}; profiles[key].name = document.getElementById('displayName').value; saveProfiles(profiles); alert('Profil lagret')
    }

    document.getElementById('avatarInput').addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ()=>{
        const profiles = loadProfiles(); const key = currentUser ? currentUser.email : 'anon'; profiles[key] = profiles[key] || {ratings:[]}; profiles[key].avatar = reader.result; saveProfiles(profiles); renderProfile(); };
      reader.readAsDataURL(f);
    });

    // ========== Search & Map ==========
    let map;
    function initMap(){ try{
      map = L.map('map').setView([60.8,11.0], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    }catch(e){ console.warn('Kart kunne ikke lastes',e) }
    }
    function renderSearchResults(){
      const q = document.getElementById('searchInput').value.toLowerCase(); const res = loadTasks().filter(t=>t.title.toLowerCase().includes(q) || (t.location||'').toLowerCase().includes(q));
      const out = document.getElementById('searchResults'); out.innerHTML=''; res.forEach(t=>{ const d=document.createElement('div'); d.className='task'; d.innerHTML=`<h4>${t.title} ${t.price?(' - '+t.price+' kr'):''}</h4><div class='meta'>${t.description}</div><div class='meta'>${t.location||''}</div>`; out.appendChild(d) });
    }

    // ========== Chat (local messages) ==========
    document.getElementById('sendMsg').onclick = ()=>{
      if(!currentUser) return alert('Logg inn for √• sende meldinger');
      const text = document.getElementById('msgInput').value; if(!text) return; const msgs = loadMessages(); const conv = msgs['global'] || []; conv.push({from:currentUser.email,text,ts:Date.now()}); msgs['global']=conv; saveMessages(msgs); renderMessages(); document.getElementById('msgInput').value='';
    }
    function renderMessages(){ const msgs=loadMessages(); const conv = msgs['global']||[]; const container = document.getElementById('messages'); container.innerHTML=''; conv.forEach(m=>{ const div=document.createElement('div'); div.className='message '+(m.from=== (currentUser?currentUser.email:'')?'me':'them'); div.textContent = m.from+': '+m.text; container.appendChild(div) }); container.scrollTop = container.scrollHeight; }

    // ========== Events & init ==========
    document.getElementById('publishTask').onclick = publishTask;
    document.getElementById('searchInput').addEventListener('input', renderSearchResults);

    // init
    initMap(); show('home'); renderFeed(); renderProfile(); renderMessages();

    // Helpful note shown in console for you as admin
    console.log('Oppdragstjenesten V3 - mobil UI (localStorage prototype). Deploy to Netlify for identity & live hosting.')
  </script>
</body>
</html>
